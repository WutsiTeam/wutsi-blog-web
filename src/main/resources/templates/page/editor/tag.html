<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" th:lang="${page.language}">
<head>
    <div th:replace="components/layout :: head"></div>
</head>

<body>

<div th:replace="components/layout :: navbar-blog(${user}, null, null)"></div>

<div class="container margin-top-2x">
    <div class="row">
        <div class="col-12 main-content offset-md-2 col-md-8 border padding-2x">

            <!-- Wizzard -->
            <div class="margin-top-2x text-center">
                <div th:replace="components/story :: wizard(3, 2)"></div>
                <h1 class="margin-top" th:text="#{page.story.publish.header1}">Title</h1>
                <h4 th:text="#{page.story.publish.tag}">Summary</h4>
            </div>

            <!-- Error -->
            <div class="alert alert-danger"
                 th:text="#{error.publish_error}"
                 th:if="${error}"
            >Error</div>

            <!-- Publish Form -->
            <form id="form-publish" method="get" action="/me/story/tag/submit" autocomplete="off" class="margin-top-2x">
                <input type="hidden" name="id" th:value="${story.id}" />

                <div class="form-group">
                    <label><span th:text="#{page.story.publish.title}">Title</span> <b class="required">*</b></label>
                    <input id="title" name="title" required="required" maxlength="200" class="form-control" th:value="${story.title}" />
                </div>

                <div class="form-group">
                    <label th:text="#{page.story.publish.tagline}">Tagline</label>
                    <input id="tagline" name="tagline" maxlength="200" class="form-control" th:value="${story.tagline}" />
                    <small class="form-text text-muted" th:text="#{page.story.publish.tagline.hint}">Help Text</small>
                </div>

                <div class="form-group">
                    <label><span th:text="#{page.story.publish.summary}">Summary</span> <b class="required">*</b></label>
                    <textarea id="summary" name="summary"  required="required" class="form-control" maxlength="255" rows="3"  th:text="${story.summary}"></textarea>
                    <small class="form-text text-muted" th:text="#{page.story.publish.summary.hint}">Help Text</small>
                </div>

                <div class="form-group">
                    <label><span th:text="#{page.story.publish.topic.info}">Information</span> <b class="required">*</b></label>
                    <select id="topic-id" class="form-control" name="topicId" required="required">
                        <option value=""></option>
                        <option
                                th:attrappend="selected = ${topic.id} == ${story.topic.id} ? selected"
                                th:value="${topic.id}"
                                th:text="${topic.displayName}"
                                th:each="topic : ${topics}"
                        >Topic</option>
                    </select>
                </div>

                <div class="form-group margin-top-2x">
                    <label><span th:text="#{page.story.publish.tag.info}">Information</span> <b class="required">*</b></label>
                    <select id="tags" class="form-control" name="tags" multiple="multiple" required="required">
                        <option selected="selected" th:value="${tag.displayName}" th:text="${tag.displayName}" th:each="tag : ${story.tags}">Tag</option>
                    </select>
                </div>

                <!-- Toolbar -->
                <div class="margin-top padding-top">
                    <a id="btn-previous" th:href="'/me/story/' + ${story.id} + '/readability'" class="btn btn-light float-left" th:text="#{button.previous}">Previous</a>

                    <button id="btn-publish" type="submit" class="float-right btn btn-primary"
                            th:if="${story.draft}"
                            th:text="#{button.publish_now}"
                    >Publish Now</button>

                    <button id="btn-publish" type="submit" class="float-right btn btn-primary"
                            th:if="${story.published}"
                            th:text="#{button.save}"
                    >Save</button>
                </div>
            </form>
        </div>
    </div>

</div>

<div th:replace="components/layout :: footer"></div>
</body>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>
<script>
    $('#topic-id').select2();

    $('#tags').select2({
        ajax: {
            url: '/tag/search',
            dataType: 'json',
            delay: 1000,
            processResults: function (tags) {
                const xtags = tags.map(function(tag){
                    return {
                        id: tag.displayName,
                        text: tag.totalStories == 0
                            ? tag.displayName
                            : tag.displayName + ' (' + tag.totalStories + ')'
                    }
                });
                return {
                    results: xtags
                };
            }
        },
        tokenSeparators: [','],
        minimumInputLength: 3,
        maximumSelectionLength: 5,
        tags: true
    });
</script>
</html>
