<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <div th:replace="components/layout :: head"></div>
</head>

<body>

<div th:replace="components/layout :: navbar"></div>

<div class="container editor border margin-top">

    <div class="row border-bottom">
        <div class="col-12 padding">
            <div id="story-status" class="hidden margin-right">Draft</div>

            <div id="story-alert" class="hidden" th:text="#{page.editor.saving}">Saving...</div>

            <div class="close">
                <a href="/story/draft">X</a>
            </div>
        </div>
    </div>

    <div class="row border-bottom">
        <div class="col-12 padding title-container">
            <input id="title" name="title" value="" th:placeholder="#{page.editor.title}"  autocomplete="off"/>
        </div>
    </div>

    <div class="row">
        <div class="col-12 editorjs-container">
            <div id="editorjs"></div>
        </div>
    </div>


</div>

<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<!--
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/link@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
-->
<script th:inline="javascript">
/*<![CDATA[*/
    var storyId = /*[[${storyId}]]*/'0';
    var labelDraft = /*[[#{story.status.draft}]]*/'Draft';
    var labelPublished = /*[[#{story.status.published}]]*/'Published';

    var dirty = false;
    function set_dirty(value) {
        console.log('set_dirty', value);
        dirty = value;
    }

    var editorjs;
    function init(story) {
        console.log('Initializing');
        init_editorjs(story);
        init_status(story);
    }
    function init_editorjs(story) {
        console.log('Initializing EditorJS');
        if (story) {
            console.log('Initializing editor with Story#' + story.id);
            $('#title').val(story.title);
            editorjs = new EditorJS({
                holderId: 'editorjs',
                autofocus: true,
                data: JSON.parse(story.content),
                onChange: function () {
                    set_dirty(true);
                }
            });

        } else {
            console.log('Initializing empty editor');

            editorjs = new EditorJS({
                holderId: 'editorjs',
                autofocus: true,
                onChange: function () {
                    set_dirty(true);
                }
            });
        }

        set_dirty(false);
    }
    function init_status(story) {
        console.log('Initializing Status');

        const selector = '#story-status';
        var text;
        var css;
        if (!story || story.draft) {
            text = labelDraft;
            css = 'status-draft';
        } else if (story && story.published) {
            text = labelPublished;
            css = 'status-published';
        }

        $(selector).text(text);
        $(selector).addClass(css);
        $(selector).removeClass('hidden');
    }

    function editorjs_save() {
        if (dirty){
            console.log("Document is dirty.Saving...");

            editorjs
                .save()
                .then(function(data){
                    set_dirty(false);
                    editorjs_save_alert(true);

                    const request = {
                        id: storyId,
                        title: $('#title').val(),
                        content: JSON.stringify(data)
                    };

                    wutsi
                        .save_story(request)
                        .then(function (story){
                            storyId = story.id;
                            editorjs_save_alert(false);
                        })
                        .catch(function (error){
                            console.error('Error while saving the document', error);
                            set_dirty(true);
                            editorjs_save_alert(false);
                        })
                    ;
                })
                .catch(function(error){
                    console.error("Save Error", error);
                });
        } else {
            console.log("Document not dirty. Nothing to save");
        }
    }
    function editorjs_save_alert(show){
        console.log("Showing save alert", show);

        const selector = '#story-alert';
        if (show) {
            $(selector).css('display', 'inline-block');
        } else {
            setTimeout(function() { $(selector).css('display', 'none'); }, wutsi.config.editor.autosave/10);
        }
    }
    setInterval(editorjs_save, wutsi.config.editor.autosave);


    $(document).ready(function(){
        if (storyId > 0){
            wutsi.story(storyId)
                .then( function(story) { init(story)})
                .catch(function(error) { console.error('Unable to load the Story#' + storyId, error) });
        } else {
            init(null);
        }

        // Event handlers
        $('#title').on('keydown', function(){ set_dirty(true)} );

        window.addEventListener('beforeunload', function(){
            console.log('Unloading the window');
            editorjs_save()
        });
    });
/*]]>*/
</script>

<div th:replace="components/layout :: footer"></div>
</body>

</html>
