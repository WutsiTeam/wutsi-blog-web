<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <div th:replace="components/layout :: head"></div>
</head>

<body>

<div th:replace="components/layout :: navbar"></div>

<div class="container">
    <div class="editor border margin-top">
        <div class="row">
            <div class="col-12">
                <div class="title-container">
                    <input id="title" name="title" value="" th:placeholder="#{page.editor.title}" />
                </div>

                <div class="editorjs-container">
                    <div id="editorjs"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script><!-- Header -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script><!-- Image -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script><!-- Delimiter -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script><!-- List -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script><!-- Checklist -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script><!-- Quote -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script><!-- Code -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script><!-- Embed -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script><!-- Table -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/link@latest"></script><!-- Link -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@latest"></script><!-- Warning -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script><!-- Marker -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script><!-- Inline Code -->
<script>
    var dirty = false;
    var storyId = 0;
    function set_dirty() {
        dirty = true;
        console.log('document is dirty');
    }

    function save() {
        console.log("save()", wutsi.config.editor.autosave);
        if (dirty){
            console.log("Saving...");

            editorjs
                .save()
                .then(function(data){
                    dirty = false;

                    wutsi
                        .save_story({
                            id: storyId,
                            title: $('#title').val(),
                            content: JSON.stringify(data)
                        })
                        .then(function (data){
                            console.log('Saved...', data);
                            storyId = data.id;
                        })
                        .catch(function (error){
                            console.log('Error while saving the document', error);
                            dirty = true;
                        });
                })
                .catch(function(error){
                    console.log("Save Error", error);
                });
        } else {
            console.log("Document not dirty. Nothing to save");
        }
    }
    setTimeout(function() { save(); }, wutsi.config.editor.autosave);

    const editorjs = new EditorJS('editorjs', {
        autofocus: true
    });

    $(document).ready(function(){

        // Detect changes
        document.addEventListener('keydown', function() {
            set_dirty()
        });
    });
</script>

<div th:replace="components/layout :: footer"></div>
</body>

</html>
