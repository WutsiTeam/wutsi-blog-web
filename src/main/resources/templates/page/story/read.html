<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" th:lang="${page.language}">
<head>
    <div th:replace="components/layout :: head"></div>
</head>

<body class="paper">

<div th:replace="components/layout :: navbar"></div>

<div class="container offset-md-2 col-md-8">

    <!-- Article -->
    <article class="border padding reader main-content margin-top">
        <div th:if="${user} AND ${user.id} == ${story.user.id}">
            <div id="story-menu" class="dropdown show story-dropdown-menu float-right">
                <a class="btn btn-light btn-sm" href="#" role="button" th:id="'story-menu-' + ${story.id}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-h"></i>
                </a>

                <div class="dropdown-menu" th:aria-labelledby="'story-menu' + ${story.id}">
                    <a class="dropdown-item menu-item-edit" th:href="'/editor/' + ${story.id}" th:text="#{button.edit}">Edit</a>
                    <a class="dropdown-item menu-item-stats" th:href="'/stats/story/' + ${story.id}" th:text="#{button.stats}" th:if="${story.published}">Stats</a>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>

        <!-- Title -->
        <h1 class="title" th:text="${story.title}">Title</h1>

        <!-- Translation -->
        <div id="translation-container" class="margin-bottom" th:if="!${preview} AND ${showTranslation}">
            <div th:if="${translationUrl}">
                <b>
                    <a class="translation-url" rel="nofollow" wutsi-track-event="translate"
                      th:href="${translationUrl}"
                      th:text="${translationText}">Translate...</a>
                </b>
            </div>
            <div th:if="${translationOriginalUrl}">
                <span th:text="#{label.translated_from}">Translated from</span>:
                <b>
                    <a class="translation-original-url" wutsi-track-event="translate_back"
                      th:href="${translationOriginalUrl}"
                      th:text="${translationOriginalTitle}">Story Title</a>
                </b>
            </div>
        </div>

        <h2 class="tagline text-center" th:text="${story.tagline}" th:if="!${story.tagline.isEmpty()}">Tagline</h2>

        <!-- Author -->
        <div class="margin-top uppercase text-small">
            <div>
                <span th:text="#{label.by}">By</span>
                <a th:href="${story.user.slug}">
                    <b th:text="${story.user.fullName}">Ray Sponsible</b></a>
            </div>
            <div>
                <span th:text="${story.readingMinutes}">2</span>
                <span th:text="#{label.minutes}">min</span>
            </div>
        </div>

        <!-- Content -->
        <div class="content margin-top" th:utext="${html}">This is a block</div>

        <!-- Tags -->
        <div class="tag-container">
            <div class="tag margin-top margin-right" th:each="tag : ${story.tags}">
                <span th:text="${tag.displayName}">Tag</span>
            </div>
        </div>

        <!-- Comment/Share -->
        <div class="widget-container padding margin-top border-top" th:if="!${preview}">
            <div class="flex">
                <div class="margin-right-2x" th:if="${toggles.like}">
                    <div th:replace="components/like :: widget(${story})"></div>
                </div>
                <div th:if="${toggles.comment}">
                    <div th:replace="components/comment :: widget(${story})"></div>
                </div>
                <div style="margin-left: auto">
                    <div th:replace="components/share :: widget(${story})"></div>
                </div>
            </div>
        </div>

    </article>

    <!-- PWA Install -->
    <div class="margin-top" th:if="${toggles.pwa}">
        <div th:replace="components/pwa :: a2hs-card"></div>
    </div>

    <!-- Recommendations -->
    <div id="recommendation-container" class="margin-top" th:if="!${preview} AND ${toggles.recommendation}">
        <div th:replace="components/story :: read-also(${story})"></div>
    </div>

    <!-- PWA Push Notification -->
    <div class="margin-top" th:if="!${preview} AND ${toggles.pwa} AND ${toggles.pwaPushNotification}">
        <div th:replace="components/pwa :: push-card"></div>
    </div>

    <!-- Author -->
    <div class="container border main-content margin-top margin-bottom-4x">
        <div class="padding">
            <div th:replace="components/story :: author-card(${story.user})"></div>
        </div>
    </div>
</div>


<div th:replace="components/google :: one-tap"></div>
<div th:replace="components/layout :: announcement"></div>
<div th:replace="components/layout :: footer"></div>

<script src="https://platform.twitter.com/widgets.js" charset="utf-8" th:if="${hasTwitterEmbed}"></script>
<script th:if="${hasTwitterEmbed}">
    $(document).ready(function(){
        $('.tweet').each( function( t, tweet ) {

            var id = jQuery(this).attr('data-id');
            twttr.widgets.createTweet(
                id, tweet,
                {
                    conversation : 'none',    // or all
                    cards        : 'hidden',  // or visible
                    linkColor    : '#1D7EDF', // default is blue
                    theme        : 'light'    // or dark
                });
        });
    });
</script>

<link rel="stylesheet" type="text/css" th:href="${page.assetUrl} + '/assets/prettify/css/prettify.css'"  th:if="${hasCode} OR ${hasRaw}" />
<script th:src="${page.assetUrl} + '/assets/prettify/js/prettify.js'" th:if="${hasCode} OR ${hasRaw}"></script>

<script id="track-script" th:inline="javascript" th:if="!${user} OR ${user.id} != ${story.user.id}">
/*<![CDATA[*/

    $(document).ready(function(){

        var prettify = /*[[${hasCode} OR ${hasRaw}]]*/'0';
        var lastScrollPercent = -1;

        wutsi.track('readstart');
        window.addEventListener('beforeunload', function(){
            wutsi.track('readend');
        });

        if (prettify){
            PR.prettyPrint();
        }

        $(window).on('scroll', function(){
            if (!should_track_scroll()) {
                return;
            }

            var s = $(window).scrollTop(),
                d = $(document).height(),
                c = $(window).height();

            var scrollPercent = ((s / (d - c)) * 100) | 0;
            if (scrollPercent % 20 == 0 && scrollPercent > lastScrollPercent && scrollPercent > 0){
                const tmpScrollPercent = lastScrollPercent;
                lastScrollPercent = scrollPercent;
                console.log('ScrollPercent', scrollPercent);

                wutsi.track('scroll', scrollPercent)
                    .catch(function () {
                        lastScrollPercent = tmpScrollPercent;
                    })
                ;
            } else {
                lastScrollPercent = scrollPercent;
            }
        });

        function should_track_scroll() {
            return !$('#comment-widget').is(':visible')
        }
    });

/*]]>*/
</script>

<script th:src="${page.assetUrl} + '/assets/wutsi/js/wutsi-comment-widget-9.js'" th:if="${toggles.comment}"></script>
<script id="comment-script" th:inline="javascript" th:if="${toggles.comment}">
/*<![CDATA[*/

    var wcomment;
    $(document).ready(function(){
        wcomment = new WutsiCommentWidget(
                /*[[${story.id}]]*/ '0',
                /*[[!${user}]]*/ true,
                /*[[${story.slug}]]*/ ''
        );
        wcomment.load();

        // Open the comment drawer based on query parameter
        const href = window.location.href;
        const index = href.indexOf('?');
        if (index>0 && href.indexOf('comment=', index) > 0){
            wcomment.show()
        }
    });

/*]]>*/
</script>

<script th:src="${page.assetUrl} + '/assets/wutsi/js/wutsi-like-widget-6.js'" th:if="${toggles.like}"></script>
<script id="like-script" th:inline="javascript" th:if="${toggles.like}">
/*<![CDATA[*/

    var wlike;
    $(document).ready(function(){
        wlike = new WutsiLikeWidget(
                /*[[${story.id}]]*/ '0',
                /*[[!${user}]]*/ true,
                /*[[${story.slug}]]*/ ''
        );

        // like based on query parameter
        const href = window.location.href;
        const index = href.indexOf('?');
        if (index>0 && href.indexOf('like=', index) > 0){
            wlike.like()
        }
    });

/*]]>*/
</script>


<div th:replace="components/pwa :: reset-badge"></div>
</body>
</html>
